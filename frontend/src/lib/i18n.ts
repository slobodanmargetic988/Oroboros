import { readonly, ref } from "vue";

export type AppLocale = "en" | "sr";

const LOCALE_STORAGE_KEY = "ouroboros.ui.locale";

const messages: Record<AppLocale, Record<string, string>> = {
  en: {
    "menu.aria": "Main navigation",
    "menu.home": "Home",
    "menu.codexInbox": "Codex Inbox",
    "menu.guides": "Guides",
    "menu.guidePublic": "Public User Guide",
    "menu.guideDeveloper": "Developer Architecture Guide",
    "menu.guideConfig": "Configuration Guide",
    "menu.guidePlatform": "Platform Prerequisites Guide",
    "menu.guideDatabase": "Database Usage Guide",
    "menu.guideFaq": "FAQ",
    "menu.language": "Language",
    "menu.english": "English",
    "menu.serbian": "Serbian",

    "common.all": "All",
    "common.refresh": "Refresh",
    "common.refreshing": "Refreshing...",
    "common.loading": "Loading...",
    "common.submitting": "Submitting...",
    "common.cancel": "Cancel",
    "common.close": "Close",
    "common.notYet": "not yet",
    "common.na": "n/a",
    "common.unknown": "unknown",

    "home.eyebrow": "Ouroboros",
    "home.title": "Home",
    "home.placeholder":
      "This is your starting point. Use Cmd+K to open up a prompt and ask it to make changes, new pages, or whatever you like.",
    "home.devAria": "Developer welcome",
    "home.devKicker": "Developer prepoznat",
    "home.devTitle": "Welcome, builder of suspiciously specific bugs.",
    "home.devBody":
      "If you are reading this with DevTools open, you are among friends. Yes, we also push a fix, reload, and act surprised when it works on the first try.",

    "codex.eyebrow": "Ouroboros",
    "codex.title": "Codex Runs Inbox",
    "codex.subhead": "Create a run request, watch status updates, and refresh inbox data in real time.",
    "codex.createRun": "Create Run",
    "codex.prompt": "Prompt",
    "codex.promptPlaceholder": "Describe the change you want to make",
    "codex.routeContext": "Route Context",
    "codex.note": "Note",
    "codex.notePlaceholder": "Optional reviewer note",
    "codex.metadata": "Metadata (JSON)",
    "codex.submitPrompt": "Submit Prompt",
    "codex.apiHint": "POST /api/runs",
    "codex.submitSuccess": "Run submitted and inbox refreshed.",
    "codex.metadataObjectError": "Metadata JSON must be an object",
    "codex.invalidMetadata": "Invalid metadata JSON: {message}",
    "codex.runsInbox": "Runs Inbox",
    "codex.statusFilter": "Status Filter",
    "codex.routeFilter": "Route Filter",
    "codex.useCurrentRoute": "Use Current Route",
    "codex.clearRouteFilter": "Clear Route Filter",
    "codex.total": "Total",
    "codex.visible": "Visible",
    "codex.occupiedSlots": "Occupied slots",
    "codex.waitingRuns": "Waiting runs",
    "codex.offset": "Offset",
    "codex.limit": "Limit",
    "codex.lastSync": "Last sync",
    "codex.slotOccupancy": "Preview Slot Occupancy",
    "codex.refreshSlots": "Refresh Slots",
    "codex.runLabel": "Run",
    "codex.openPreview": "Open preview",
    "codex.expires": "Expires",
    "codex.noSlots": "No slot records available.",
    "codex.relatedRoute": "Related to current route",
    "codex.noRouteRelatedRuns": "No route-related runs for this page right now.",
    "codex.loadingRuns": "Loading runs...",
    "codex.viewDetails": "View details",
    "codex.id": "ID",
    "codex.route": "Route",
    "codex.slot": "Slot",
    "codex.waiting": "Waiting",
    "codex.onThisPage": "On this page",
    "codex.noteLabel": "Note",
    "codex.previous": "Previous",
    "codex.next": "Next",
    "codex.emptyLoadError": "Unable to load runs. Try refresh.",
    "codex.emptyFiltered": "No runs found for current filter settings.",
    "codex.emptyNoRuns": "No runs yet. Create a run from the composer above.",

    "runDetails.eyebrow": "Codex Run",
    "runDetails.title": "Run Details",
    "runDetails.subhead":
      "Timeline, validation checks, logs, artifacts, and review decisions for a single run.",
    "runDetails.backHome": "Home",
    "runDetails.backInbox": "Back to Inbox",
    "runDetails.sectionsAria": "Run details sections",
    "runDetails.summary": "Run Summary",
    "runDetails.id": "ID",
    "runDetails.loadingRunDetails": "Loading run details...",
    "runDetails.route": "Route",
    "runDetails.slot": "Slot",
    "runDetails.branch": "Branch",
    "runDetails.commit": "Commit",
    "runDetails.updated": "Updated",
    "runDetails.lastSync": "Last sync",
    "runDetails.unavailable": "Run details are unavailable.",
    "runDetails.changeReview": "Change Review",
    "runDetails.fileDiffView": "File Diff View",
    "runDetails.source": "Source",
    "runDetails.showPatchSnippet": "Show patch snippet",
    "runDetails.noFileDiff": "No file-level diff payload found yet for this run.",
    "runDetails.migrationWarning": "Migration Warning",
    "runDetails.migrationWarningBody":
      "Migration-related files are present in the diff. Require explicit DB review before merge.",
    "runDetails.noMigrationWarning": "No migration files detected in current diff payload.",
    "runDetails.failureReasons": "Failure Reasons",
    "runDetails.noFailureReasons": "No failure reasons recorded for this run.",
    "runDetails.checksSummary": "Checks Summary",
    "runDetails.total": "Total",
    "runDetails.passed": "Passed",
    "runDetails.failed": "Failed",
    "runDetails.running": "Running",
    "runDetails.pending": "Pending",
    "runDetails.validationChecks": "Validation Checks",
    "runDetails.started": "Started",
    "runDetails.ended": "Ended",
    "runDetails.duration": "Duration",
    "runDetails.openArtifact": "Open check artifact/log",
    "runDetails.noValidationChecks": "No validation checks found for this run.",
    "runDetails.approvalActions": "Approval Actions",
    "runDetails.approveRun": "Approve Run",
    "runDetails.rejectRun": "Reject Run",
    "runDetails.expireRun": "Expire Run",
    "runDetails.resumeRun": "Resume Run",
    "runDetails.currentRunStatus": "Current run status",
    "runDetails.approvalHintOne":
      "Approve is available in preview_ready and needs_approval. Reject is disabled in merged.",
    "runDetails.approvalHintTwo":
      "Decision History records approve/reject actions. Expire/resume appear in Timeline events.",
    "runDetails.decisionHistory": "Decision History",
    "runDetails.reviewer": "Recenzent",
    "runDetails.noApprovals": "No approvals/rejections recorded for this run yet.",
    "runDetails.closeDialog": "Close dialog",
    "runDetails.reviewerOptional": "Reviewer ID (optional)",
    "runDetails.reviewerPlaceholder": "reviewer user id",
    "runDetails.approveReasonOptional": "Approve reason (optional)",
    "runDetails.approveReasonPlaceholder": "Reason for approval",
    "runDetails.rejectReasonRequired": "Reject reason (required)",
    "runDetails.rejectReasonPlaceholder": "Reason for rejection",
    "runDetails.failureReasonCode": "Failure reason code",
    "runDetails.expireReasonOptional": "Expire reason (optional)",
    "runDetails.expireReasonPlaceholder": "Reason for manual expiration",
    "runDetails.resumeHint": "This creates a queued child run from the current failed/expired run.",
    "runDetails.artifactLinks": "Artifact Links",
    "runDetails.noArtifactLinks": "No artifact links available for this run.",
    "runDetails.timeline": "Timeline",
    "runDetails.from": "From",
    "runDetails.to": "To",
    "runDetails.showPayload": "Show payload JSON",
    "runDetails.noTimeline": "No timeline events found for this run.",
    "runDetails.modalApproveTitle": "Approve Run",
    "runDetails.modalRejectTitle": "Reject Run",
    "runDetails.modalExpireTitle": "Expire Run",
    "runDetails.modalResumeTitle": "Resume Run",
    "runDetails.modalDefaultTitle": "Run Action",
    "runDetails.modalApproveSubhead": "Approving will continue merge/deploy pipeline checks for this run.",
    "runDetails.modalRejectSubhead": "Rejecting records a decision and applies the selected failure reason code.",
    "runDetails.modalExpireSubhead": "Expire sets recoverable reason code PREVIEW_EXPIRED.",
    "runDetails.modalResumeSubhead": "Resume creates a queued child run from this failed/expired run.",
    "runDetails.navSummary": "Summary",
    "runDetails.navChangeReview": "Change Review",
    "runDetails.navFailures": "Failures",
    "runDetails.navChecks": "Checks",
    "runDetails.navValidation": "Validation",
    "runDetails.navActions": "Actions",
    "runDetails.navArtifacts": "Artifacts",
    "runDetails.navTimeline": "Timeline",
    "runDetails.notStarted": "not started",
    "runDetails.invalidRunId": "Invalid run id in route.",
    "runDetails.errorApproveState": "Run must be in preview_ready or needs_approval state before approving.",
    "runDetails.errorRunNotLoaded": "Run is not loaded yet.",
    "runDetails.errorCannotExpire": "Run cannot be manually expired in current state.",
    "runDetails.errorCannotResume": "Run must be failed or expired before resuming.",
    "runDetails.errorRejectReasonRequired": "Reject reason is required.",
    "runDetails.successApproved": "Run approved successfully.",
    "runDetails.successRejected": "Run rejected successfully.",
    "runDetails.successExpired": "Run expired with PREVIEW_EXPIRED recoverable reason.",
    "runDetails.successChildQueued": "Child run queued: {id}",

    "shortcuts.closePrompt": "Close quick prompt",
    "shortcuts.eyebrow": "Global Shortcut",
    "shortcuts.title": "Quick Codex Prompt",
    "shortcuts.subhead": "Current route will be attached automatically.",
    "shortcuts.prompt": "Prompt",
    "shortcuts.promptPlaceholder": "Describe the change you want to request",
    "shortcuts.route": "Route",
    "shortcuts.optionalNote": "Optional Note",
    "shortcuts.notePlaceholder": "Extra context for this route",
    "shortcuts.createRun": "Create Run",
    "shortcuts.shortcutHint": "Shortcut: Cmd/Ctrl+K to open, Esc to close.",
    "shortcuts.successCreated": "Run request created.",

    "routeRuns.toggle": "Route Runs",
    "routeRuns.hide": "Hide",
    "routeRuns.loading": "Loading route runs...",
    "routeRuns.empty": "No runs linked to this route yet.",
    "routeRuns.openRelated": "Open related runs in inbox",

    "notifications.aria": "Run lifecycle notifications",
    "notifications.openRunDetails": "Open run details",
    "notifications.toggle": "Notifications",
    "notifications.inboxAria": "Notifications inbox",
    "notifications.inboxTitle": "Run Notifications",
    "notifications.markAllSeen": "Mark all seen",
    "notifications.clear": "Clear",
    "notifications.user": "User",
    "notifications.loading": "Loading notifications...",
    "notifications.markSeen": "Mark seen",
    "notifications.empty": "No notifications yet.",
    "notifications.truncated": "Notifications truncated to newest {count} runs.",
    "notifications.statusPreviewReady": "Run is preview-ready and can be reviewed.",
    "notifications.statusFailed": "Run failed and needs attention.",
    "notifications.statusMerged": "Run was merged successfully.",
    "notifications.statusCanceled": "Run was canceled.",
    "notifications.statusFallback": "Run transitioned to {status}.",
  },
  sr: {
    "menu.aria": "Glavna navigacija",
    "menu.home": "Početna",
    "menu.codexInbox": "Codex Inbox",
    "menu.guides": "Vodiči",
    "menu.guidePublic": "Javni korisnički vodič",
    "menu.guideDeveloper": "Vodič za arhitekturu za developere",
    "menu.guideConfig": "Vodič za konfiguraciju",
    "menu.guidePlatform": "Vodič za preduslove platforme",
    "menu.guideDatabase": "Vodič za korišćenje baze",
    "menu.guideFaq": "FAQ",
    "menu.language": "Jezik",
    "menu.english": "Engleski",
    "menu.serbian": "Srpski",

    "common.all": "Sve",
    "common.refresh": "Osveži",
    "common.refreshing": "Osvežavanje...",
    "common.loading": "Učitavanje...",
    "common.submitting": "Slanje...",
    "common.cancel": "Otkaži",
    "common.close": "Zatvori",
    "common.notYet": "još nije",
    "common.na": "n/d",
    "common.unknown": "nepoznato",

    "home.eyebrow": "Ouroboros",
    "home.title": "Početna",
    "home.placeholder":
      "Ovo je tvoja početna tačka. Koristi Cmd+K da otvoriš prompt i zatražiš izmene, nove stranice ili šta god želiš.",
    "home.devAria": "Poruka za developere",
    "home.devKicker": "Developer Detected",
    "home.devTitle": "Dobrodošao, graditelju sumnjivo specifičnih bagova.",
    "home.devBody":
      "Ako ovo čitaš sa otvorenim DevTools-om, među svojima si. I mi guramo fix, reloadujemo i pravimo se iznenađeni kad proradi iz prve.",

    "codex.eyebrow": "Ouroboros",
    "codex.title": "Inbox za Codex run-ove",
    "codex.subhead": "Kreiraj run zahtev, prati promene statusa i osvežavaj inbox podatke u realnom vremenu.",
    "codex.createRun": "Kreiraj run",
    "codex.prompt": "Prompt",
    "codex.promptPlaceholder": "Opiši izmenu koju želiš da napraviš",
    "codex.routeContext": "Kontekst rute",
    "codex.note": "Napomena",
    "codex.notePlaceholder": "Opciona napomena za review",
    "codex.metadata": "Metapodaci (JSON)",
    "codex.submitPrompt": "Pošalji prompt",
    "codex.apiHint": "POST /api/runs",
    "codex.submitSuccess": "Run je poslat i inbox je osvežen.",
    "codex.metadataObjectError": "Metadata JSON mora biti objekat",
    "codex.invalidMetadata": "Neispravan metadata JSON: {message}",
    "codex.runsInbox": "Run inbox",
    "codex.statusFilter": "Filter statusa",
    "codex.routeFilter": "Filter rute",
    "codex.useCurrentRoute": "Koristi trenutnu rutu",
    "codex.clearRouteFilter": "Očisti filter rute",
    "codex.total": "Ukupno",
    "codex.visible": "Prikazano",
    "codex.occupiedSlots": "Zauzeti slotovi",
    "codex.waitingRuns": "Run-ovi na čekanju",
    "codex.offset": "Pomak",
    "codex.limit": "Limit",
    "codex.lastSync": "Poslednja sinhronizacija",
    "codex.slotOccupancy": "Zauzeće preview slotova",
    "codex.refreshSlots": "Osveži slotove",
    "codex.runLabel": "Run",
    "codex.openPreview": "Otvori preview",
    "codex.expires": "Ističe",
    "codex.noSlots": "Nema dostupnih zapisa o slotovima.",
    "codex.relatedRoute": "Povezano sa trenutnom rutom",
    "codex.noRouteRelatedRuns": "Trenutno nema run-ova povezanih sa ovom stranicom.",
    "codex.loadingRuns": "Učitavanje run-ova...",
    "codex.viewDetails": "Prikaži detalje",
    "codex.id": "ID",
    "codex.route": "Ruta",
    "codex.slot": "Slot",
    "codex.waiting": "Čeka",
    "codex.onThisPage": "Na ovoj stranici",
    "codex.noteLabel": "Napomena",
    "codex.previous": "Prethodna",
    "codex.next": "Sledeća",
    "codex.emptyLoadError": "Ne mogu da učitam run-ove. Probaj osvežavanje.",
    "codex.emptyFiltered": "Nema run-ova za trenutno podešene filtere.",
    "codex.emptyNoRuns": "Još nema run-ova. Kreiraj run iz forme iznad.",

    "runDetails.eyebrow": "Codex Run",
    "runDetails.title": "Detalji run-a",
    "runDetails.subhead": "Timeline, validacione provere, logovi, artefakti i review odluke za jedan run.",
    "runDetails.backHome": "Početna",
    "runDetails.backInbox": "Nazad na inbox",
    "runDetails.sectionsAria": "Sekcije detalja run-a",
    "runDetails.summary": "Sažetak run-a",
    "runDetails.id": "ID",
    "runDetails.loadingRunDetails": "Učitavanje detalja run-a...",
    "runDetails.route": "Ruta",
    "runDetails.slot": "Slot",
    "runDetails.branch": "Grana",
    "runDetails.commit": "Commit",
    "runDetails.updated": "Ažurirano",
    "runDetails.lastSync": "Poslednja sinhronizacija",
    "runDetails.unavailable": "Detalji run-a nisu dostupni.",
    "runDetails.changeReview": "Review izmena",
    "runDetails.fileDiffView": "Prikaz diff fajlova",
    "runDetails.source": "Izvor",
    "runDetails.showPatchSnippet": "Prikaži isečak patch-a",
    "runDetails.noFileDiff": "Još nema payload-a sa diff-om po fajlovima za ovaj run.",
    "runDetails.migrationWarning": "Upozorenje za migracije",
    "runDetails.migrationWarningBody":
      "U diff-u postoje fajlovi vezani za migracije. Potreban je eksplicitan DB review pre merge-a.",
    "runDetails.noMigrationWarning": "Nema fajlova migracija u trenutnom diff payload-u.",
    "runDetails.failureReasons": "Razlozi neuspeha",
    "runDetails.noFailureReasons": "Nema zabeleženih razloga neuspeha za ovaj run.",
    "runDetails.checksSummary": "Sažetak provera",
    "runDetails.total": "Ukupno",
    "runDetails.passed": "Prošlo",
    "runDetails.failed": "Palo",
    "runDetails.running": "U toku",
    "runDetails.pending": "Na čekanju",
    "runDetails.validationChecks": "Validacione provere",
    "runDetails.started": "Početak",
    "runDetails.ended": "Kraj",
    "runDetails.duration": "Trajanje",
    "runDetails.openArtifact": "Otvori artefakt/log provere",
    "runDetails.noValidationChecks": "Nema validacionih provera za ovaj run.",
    "runDetails.approvalActions": "Akcije odobravanja",
    "runDetails.approveRun": "Odobri run",
    "runDetails.rejectRun": "Odbij run",
    "runDetails.expireRun": "Istekni run",
    "runDetails.resumeRun": "Nastavi run",
    "runDetails.currentRunStatus": "Trenutni status run-a",
    "runDetails.approvalHintOne":
      "Odobravanje je dostupno u preview_ready i needs_approval. Odbijanje je onemogućeno u merged.",
    "runDetails.approvalHintTwo":
      "Istorija odluka beleži approve/reject akcije. Expire/resume su u Timeline događajima.",
    "runDetails.decisionHistory": "Istorija odluka",
    "runDetails.reviewer": "Reviewer",
    "runDetails.noApprovals": "Još nema zabeleženih odobravanja/odbijanja za ovaj run.",
    "runDetails.closeDialog": "Zatvori dijalog",
    "runDetails.reviewerOptional": "ID recenzenta (opciono)",
    "runDetails.reviewerPlaceholder": "id korisnika recenzenta",
    "runDetails.approveReasonOptional": "Razlog odobravanja (opciono)",
    "runDetails.approveReasonPlaceholder": "Razlog odobravanja",
    "runDetails.rejectReasonRequired": "Razlog odbijanja (obavezno)",
    "runDetails.rejectReasonPlaceholder": "Razlog odbijanja",
    "runDetails.failureReasonCode": "Kod razloga neuspeha",
    "runDetails.expireReasonOptional": "Razlog isteka (opciono)",
    "runDetails.expireReasonPlaceholder": "Razlog ručnog isteka",
    "runDetails.resumeHint": "Ovo kreira queued child run iz trenutnog failed/expired run-a.",
    "runDetails.artifactLinks": "Linkovi artefakata",
    "runDetails.noArtifactLinks": "Nema dostupnih linkova artefakata za ovaj run.",
    "runDetails.timeline": "Timeline",
    "runDetails.from": "Iz",
    "runDetails.to": "U",
    "runDetails.showPayload": "Prikaži payload JSON",
    "runDetails.noTimeline": "Nema timeline događaja za ovaj run.",
    "runDetails.modalApproveTitle": "Odobri run",
    "runDetails.modalRejectTitle": "Odbij run",
    "runDetails.modalExpireTitle": "Istekni run",
    "runDetails.modalResumeTitle": "Nastavi run",
    "runDetails.modalDefaultTitle": "Run akcija",
    "runDetails.modalApproveSubhead": "Odobravanje nastavlja merge/deploy pipeline provere za ovaj run.",
    "runDetails.modalRejectSubhead": "Odbijanje beleži odluku i primenjuje izabrani kod razloga neuspeha.",
    "runDetails.modalExpireSubhead": "Expire postavlja recoverable reason code PREVIEW_EXPIRED.",
    "runDetails.modalResumeSubhead": "Resume kreira queued child run iz ovog failed/expired run-a.",
    "runDetails.navSummary": "Sažetak",
    "runDetails.navChangeReview": "Review izmena",
    "runDetails.navFailures": "Neuspesi",
    "runDetails.navChecks": "Provere",
    "runDetails.navValidation": "Validacija",
    "runDetails.navActions": "Akcije",
    "runDetails.navArtifacts": "Artefakti",
    "runDetails.navTimeline": "Timeline",
    "runDetails.notStarted": "nije počelo",
    "runDetails.invalidRunId": "Neispravan run id u ruti.",
    "runDetails.errorApproveState": "Run mora biti u preview_ready ili needs_approval stanju pre odobravanja.",
    "runDetails.errorRunNotLoaded": "Run još nije učitan.",
    "runDetails.errorCannotExpire": "Run ne može ručno da istekne u trenutnom stanju.",
    "runDetails.errorCannotResume": "Run mora biti failed ili expired pre nastavka.",
    "runDetails.errorRejectReasonRequired": "Razlog odbijanja je obavezan.",
    "runDetails.successApproved": "Run je uspešno odobren.",
    "runDetails.successRejected": "Run je uspešno odbijen.",
    "runDetails.successExpired": "Run je istekao sa PREVIEW_EXPIRED recoverable reason kodom.",
    "runDetails.successChildQueued": "Child run je stavljen u red: {id}",

    "shortcuts.closePrompt": "Zatvori brzi prompt",
    "shortcuts.eyebrow": "Globalna prečica",
    "shortcuts.title": "Brzi Codex prompt",
    "shortcuts.subhead": "Trenutna ruta će biti automatski prikačena.",
    "shortcuts.prompt": "Prompt",
    "shortcuts.promptPlaceholder": "Opiši izmenu koju želiš da zatražiš",
    "shortcuts.route": "Ruta",
    "shortcuts.optionalNote": "Opciona napomena",
    "shortcuts.notePlaceholder": "Dodatni kontekst za ovu rutu",
    "shortcuts.createRun": "Kreiraj run",
    "shortcuts.shortcutHint": "Prečica: Cmd/Ctrl+K za otvaranje, Esc za zatvaranje.",
    "shortcuts.successCreated": "Run zahtev je kreiran.",

    "routeRuns.toggle": "Run-ovi rute",
    "routeRuns.hide": "Sakrij",
    "routeRuns.loading": "Učitavanje run-ova rute...",
    "routeRuns.empty": "Još nema run-ova vezanih za ovu rutu.",
    "routeRuns.openRelated": "Otvori povezane run-ove u inbox-u",

    "notifications.aria": "Notifikacije o životnom ciklusu run-a",
    "notifications.openRunDetails": "Otvori detalje run-a",
    "notifications.toggle": "Notifikacije",
    "notifications.inboxAria": "Inbox notifikacija",
    "notifications.inboxTitle": "Run notifikacije",
    "notifications.markAllSeen": "Označi sve kao viđeno",
    "notifications.clear": "Očisti",
    "notifications.user": "Korisnik",
    "notifications.loading": "Učitavanje notifikacija...",
    "notifications.markSeen": "Označi kao viđeno",
    "notifications.empty": "Još nema notifikacija.",
    "notifications.truncated": "Notifikacije su ograničene na najnovijih {count} run-ova.",
    "notifications.statusPreviewReady": "Run je spreman za preview i može na review.",
    "notifications.statusFailed": "Run je pao i zahteva pažnju.",
    "notifications.statusMerged": "Run je uspešno merge-ovan.",
    "notifications.statusCanceled": "Run je otkazan.",
    "notifications.statusFallback": "Run je prešao u status {status}.",
  },
};

function resolveInitialLocale(): AppLocale {
  if (typeof window === "undefined") {
    return "en";
  }
  const stored = window.localStorage.getItem(LOCALE_STORAGE_KEY);
  if (stored === "en" || stored === "sr") {
    return stored;
  }
  const browserLocale = window.navigator.language.toLowerCase();
  if (browserLocale.startsWith("sr")) {
    return "sr";
  }
  return "en";
}

const localeState = ref<AppLocale>(resolveInitialLocale());

function syncDocumentLanguage(nextLocale: AppLocale): void {
  if (typeof document === "undefined") {
    return;
  }
  document.documentElement.lang = nextLocale;
}

function applyLocale(nextLocale: AppLocale): void {
  localeState.value = nextLocale;
  syncDocumentLanguage(nextLocale);
  if (typeof window !== "undefined") {
    window.localStorage.setItem(LOCALE_STORAGE_KEY, nextLocale);
  }
}

function interpolate(template: string, params?: Record<string, string | number>): string {
  if (!params) {
    return template;
  }
  return template.replace(/\{(\w+)\}/g, (_, key: string) => String(params[key] ?? ""));
}

function translate(key: string, params?: Record<string, string | number>): string {
  const message = messages[localeState.value][key] ?? messages.en[key] ?? key;
  return interpolate(message, params);
}

syncDocumentLanguage(localeState.value);

export function useI18n() {
  return {
    locale: readonly(localeState),
    setLocale: applyLocale,
    t: translate,
  };
}
