<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ouroboros Database Usage Guide</title>
  <style>
    :root {
      --bg: #f3f7fc;
      --panel: #ffffff;
      --ink: #16223f;
      --muted: #56668a;
      --line: #d7e2f3;
      --brand: #0f54ff;
      --brand-soft: #e8efff;
      --ok: #0f6b3a;
      --warn: #8c5300;
      --bad: #a32626;
      --shadow: 0 16px 38px rgba(22, 44, 88, 0.12);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", "Avenir Next", "Helvetica Neue", Arial, sans-serif;
      color: var(--ink);
      line-height: 1.56;
      background:
        radial-gradient(960px 470px at 95% -10%, #dbe8ff 0%, transparent 62%),
        radial-gradient(840px 430px at -12% 0%, #eaf2ff 0%, transparent 58%),
        var(--bg);
    }

    .top-menu {
      position: sticky;
      top: 0;
      z-index: 90;
      border-bottom: 1px solid var(--line);
      background: rgba(255, 255, 255, 0.97);
      backdrop-filter: blur(6px);
      padding: 0.55rem 1rem;
    }

    .top-menu-inner {
      width: min(1220px, calc(100% - 2rem));
      margin: 0 auto;
      display: flex;
      align-items: center;
      gap: 0.55rem;
    }

    .top-link,
    .top-trigger {
      display: inline-block;
      border: 1px solid #cbd5e1;
      border-radius: 10px;
      background: #f8fafc;
      color: #0f172a;
      text-decoration: none;
      font-size: 0.9rem;
      font-weight: 600;
      padding: 0.45rem 0.7rem;
      cursor: pointer;
      font-family: inherit;
      line-height: 1.2;
    }

    .top-link:hover,
    .top-trigger:hover {
      background: #eff6ff;
      color: #1e40af;
    }

    .top-link.is-active {
      border-color: #93c5fd;
      color: #1e3a8a;
    }

    .top-dropdown {
      position: relative;
    }

    .top-caret {
      margin-left: 0.3rem;
    }

    .top-panel {
      position: absolute;
      z-index: 20;
      margin-top: 0.45rem;
      min-width: 280px;
      display: none;
      gap: 0.2rem;
      border: 1px solid #d8e2ec;
      border-radius: 10px;
      background: #ffffff;
      box-shadow: 0 14px 28px rgba(15, 23, 42, 0.12);
      padding: 0.4rem;
    }

    .top-panel.is-open {
      display: grid;
    }

    .top-panel a {
      color: #1e293b;
      text-decoration: none;
      border-radius: 8px;
      padding: 0.42rem 0.5rem;
      font-size: 0.9rem;
    }

    .top-panel a:hover,
    .top-panel a.is-active {
      background: #eff6ff;
      color: #1e40af;
    }

    .wrap {
      width: min(1220px, calc(100% - 2rem));
      margin: 1.75rem auto 3rem;
    }

    .hero {
      position: relative;
      overflow: hidden;
      border: 1px solid var(--line);
      border-radius: 20px;
      box-shadow: var(--shadow);
      background: linear-gradient(130deg, #f8fbff 0%, #edf3ff 100%);
      padding: 2rem;
    }

    .hero-mark {
      position: absolute;
      top: 0px;
      right: 28px;
      width: auto;
      max-width: clamp(170px, 19vw, 250px);
      height: auto;
      max-height: 100%;
      opacity: 0.42;
      pointer-events: none;
      z-index: 0;
    }

    .hero> :not(.hero-mark) {
      position: relative;
      z-index: 1;
    }

    .eyebrow {
      margin: 0 0 0.35rem;
      font-size: 0.8rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      font-weight: 700;
      color: #2148a1;
    }

    h1 {
      margin: 0;
      font-size: clamp(1.75rem, 3.5vw, 2.6rem);
      line-height: 1.15;
    }

    .lead {
      margin: 0.85rem 0 0;
      color: #30436d;
      max-width: 100ch;
    }

    .section {
      margin-top: 1.1rem;
      border: 1px solid var(--line);
      border-radius: 16px;
      box-shadow: var(--shadow);
      background: var(--panel);
      padding: 1.15rem;
    }

    .section h2 {
      margin: 0 0 0.55rem;
      font-size: 1.22rem;
    }

    .section h3 {
      margin: 0.8rem 0 0.35rem;
      font-size: 1.04rem;
    }

    p {
      margin: 0.35rem 0;
    }

    ul,
    ol {
      margin: 0.45rem 0 0;
      padding-left: 1.2rem;
    }

    li {
      margin-bottom: 0.45rem;
    }

    .table-wrap {
      overflow-x: auto;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      min-width: 760px;
    }

    th,
    td {
      border: 1px solid var(--line);
      text-align: left;
      vertical-align: top;
      padding: 0.55rem;
      font-size: 0.93rem;
    }

    th {
      background: #f2f7ff;
    }

    .hint {
      margin-top: 0.7rem;
      border-left: 3px solid var(--brand);
      background: var(--brand-soft);
      color: #1a3468;
      border-radius: 8px;
      padding: 0.65rem 0.75rem;
    }

    .ok {
      color: var(--ok);
      font-weight: 600;
    }

    .warn {
      color: var(--warn);
      font-weight: 600;
    }

    .bad {
      color: var(--bad);
      font-weight: 600;
    }

    code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      font-size: 0.85rem;
      padding: 0.04rem 0.35rem;
      border-radius: 6px;
      border: 1px solid #d6e0f3;
      background: #f3f7ff;
    }

    pre {
      margin: 0.5rem 0 0;
      border: 1px solid #d6e0f3;
      border-radius: 10px;
      background: #f4f8ff;
      padding: 0.72rem;
      overflow-x: auto;
    }

    .small {
      color: #657498;
      font-size: 0.9rem;
    }

    @media (max-width: 720px) {
      .hero-mark {
        width: 132px;
        top: 16px;
        right: 16px;
        opacity: 0.3;
      }
    }
  </style>
</head>

<body>
  <nav class="top-menu" aria-label="Ouroboros navigation">
    <div class="top-menu-inner">
      <a class="top-link" href="/home">Home</a>
      <a class="top-link" href="/codex">Codex Inbox</a>
      <div class="top-dropdown" data-docs-menu>
        <button type="button" class="top-trigger" aria-haspopup="true" aria-expanded="false">
          Guides <span class="top-caret">â–¾</span>
        </button>
        <div class="top-panel" role="menu">
          <a href="/docs/public-user-guide.html">Public User Guide</a>
          <a href="/docs/developer-architecture-guide.html">Developer Architecture Guide</a>
          <a href="/docs/configuration-guide.html">Configuration Guide</a>
          <a href="/docs/platform-prerequisites-guide.html">Platform Prerequisites Guide</a>
          <a href="/docs/database-usage-guide.html">Database Usage Guide</a>
          <a href="/docs/faq.html">FAQ</a>
        </div>
      </div>
    </div>
  </nav>

  <main class="wrap">
    <header class="hero">
      <img class="hero-mark" src="../Ouroboros.png" alt="" />
      <p class="eyebrow">Ouroboros</p>
      <h1>Database Usage Guide</h1>
      <p class="lead">
        This explains how database state is used during runs, previews, approvals, and failures. It also covers what
        happens when a preview slot gets dirty and is reused by a later run.
      </p>
    </header>

    <section class="section">
      <h2>1) Two Database Domains</h2>
      <ul>
        <li><strong>Control-plane DB</strong> (<code>builder_control</code>): stores runs, events, checks, approvals,
          leases, releases, audit.</li>
        <li><strong>Preview app DBs</strong>: one DB per preview slot (<code>app_preview_1</code>, <code>_2</code>,
          <code>_3</code>).
        </li>
      </ul>
      <p class="hint">
        Preview DBs are disposable test sandboxes. Production/control records are kept in the control-plane DB.
      </p>
    </section>

    <section class="section">
      <h2>2) Core Tables and Their Job</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Table</th>
              <th>Purpose</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><code>runs</code></td>
              <td>Current run snapshot (status, slot, branch, worktree, commit).</td>
            </tr>
            <tr>
              <td><code>run_context</code></td>
              <td>Route/page/note/metadata captured when run was created.</td>
            </tr>
            <tr>
              <td><code>run_events</code></td>
              <td>Append-only event timeline for each run.</td>
            </tr>
            <tr>
              <td><code>validation_checks</code></td>
              <td>Pass/fail/timed-out checks and log URIs.</td>
            </tr>
            <tr>
              <td><code>run_artifacts</code></td>
              <td>Command outputs and generated artifacts.</td>
            </tr>
            <tr>
              <td><code>slot_leases</code></td>
              <td>Which run currently owns each preview slot lease.</td>
            </tr>
            <tr>
              <td><code>slot_worktree_bindings</code></td>
              <td>Slot -> branch/worktree assignment state.</td>
            </tr>
            <tr>
              <td><code>preview_db_resets</code></td>
              <td>Reset+seed lifecycle records for preview DBs.</td>
            </tr>
            <tr>
              <td><code>approvals</code></td>
              <td>Approve/reject decisions with reason/reviewer.</td>
            </tr>
            <tr>
              <td><code>releases</code></td>
              <td>Deployment release history.</td>
            </tr>
            <tr>
              <td><code>audit_log</code></td>
              <td>Auditable action log with payload hash.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="section">
      <h2>3) What Happens On Every New Claimed Run</h2>
      <ol>
        <li>Worker claims a queued run and acquires a slot lease.</li>
        <li>Run transitions to <code>planning</code>.</li>
        <li>Worktree is assigned for that slot/branch.</li>
        <li><strong>Before editing starts</strong>, worker performs preview DB reset+seed for the slot.</li>
        <li>Reset is recorded in <code>preview_db_resets</code> and as run events.</li>
        <li>Only after successful reset does run enter <code>editing</code>.</li>
      </ol>
      <p class="ok">This is now enforced in the worker orchestration path.</p>
    </section>

    <section class="section">
      <h2>4) Your Scenario: Dirty Preview Then Canceled Run</h2>
      <h3>Scenario</h3>
      <p>
        Run A uses <code>preview-1</code>, modifies preview DB state during testing, then gets canceled/rejected.
        Later Run B gets <code>preview-1</code>.
      </p>
      <h3>What happens now</h3>
      <ol>
        <li>Run A ends; slot lease is released.</li>
        <li>Run B claims <code>preview-1</code>.</li>
        <li>Worker executes reset+seed on <code>app_preview_1</code> before editing.</li>
        <li>Run B sees a fresh deterministic DB baseline, not Run A leftovers.</li>
      </ol>
      <p class="ok">Result: preview state isolation between runs is preserved.</p>
    </section>

    <section class="section">
      <h2>5) If Reset Fails</h2>
      <ol>
        <li>Reset record in <code>preview_db_resets</code> is marked <code>failed</code>.</li>
        <li>Run gets a failure transition with reason <code>MIGRATION_FAILED</code>.</li>
        <li>Slot lease is released so other runs are not blocked.</li>
        <li>No editing/testing proceeds for that run.</li>
      </ol>
      <p class="warn">This is fail-fast behavior to avoid running on an unknown/dirty preview DB state.</p>
    </section>

    <section class="section">
      <h2>6) Other Important Scenarios</h2>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Scenario</th>
              <th>Behavior</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>All slots busy</td>
              <td>Run stays queued with <code>WAITING_FOR_SLOT</code>.</td>
            </tr>
            <tr>
              <td>Worker timeout</td>
              <td>Run transitions failed with <code>AGENT_TIMEOUT</code>; resume endpoint metadata provided.</td>
            </tr>
            <tr>
              <td>Lease expires mid-run</td>
              <td>Run transitions to expired/failure path with preview-expired semantics and released lease.</td>
            </tr>
            <tr>
              <td>Checks fail</td>
              <td>Run transitions failed with <code>CHECKS_FAILED</code> and failed check metadata.</td>
            </tr>
            <tr>
              <td>Approve + merge gate fails</td>
              <td>Run transitions failed (for example merge conflict/check failure), remains unmerged.</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>

    <section class="section">
      <h2>7) Useful SQL Examples</h2>
      <h3>Latest reset records</h3>
      <pre><code>SELECT run_id, slot_id, db_name, strategy, reset_status, reset_started_at, reset_completed_at
FROM preview_db_resets
ORDER BY id DESC
LIMIT 20;</code></pre>

      <h3>Timeline for one run</h3>
      <pre><code>SELECT id, event_type, status_from, status_to, payload, created_at
FROM run_events
WHERE run_id = '&lt;run_id&gt;'
ORDER BY id ASC;</code></pre>

      <h3>Current slot occupancy</h3>
      <pre><code>SELECT slot_id, run_id, lease_state, expires_at, heartbeat_at
FROM slot_leases
ORDER BY slot_id;</code></pre>
    </section>

    <section class="section">
      <h2>8) Operational Recommendations</h2>
      <ul>
        <li>Keep preview reset strategy deterministic (<code>seed</code> + versioned seeds).</li>
        <li>Monitor <code>preview_db_resets.reset_status</code> for failures and trend changes.</li>
        <li>Never treat preview DBs as long-lived state stores.</li>
        <li>Investigate repeated reset failures before increasing run concurrency.</li>
      </ul>
      <p class="small">
        Related docs: <code>docs/db-bootstrap-and-migrations.md</code>, <code>docs/configuration-guide.html</code>.
      </p>
    </section>
  </main>
  <script>
    (() => {
      const dropdown = document.querySelector("[data-docs-menu]");
      if (!dropdown) return;

      const trigger = dropdown.querySelector(".top-trigger");
      const panel = dropdown.querySelector(".top-panel");
      if (!trigger || !panel) return;

      const closeMenu = () => {
        panel.classList.remove("is-open");
        trigger.setAttribute("aria-expanded", "false");
      };

      trigger.addEventListener("click", (event) => {
        event.stopPropagation();
        const next = !panel.classList.contains("is-open");
        panel.classList.toggle("is-open", next);
        trigger.setAttribute("aria-expanded", String(next));
      });

      document.addEventListener("click", (event) => {
        if (!dropdown.contains(event.target)) {
          closeMenu();
        }
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeMenu();
        }
      });

      panel.querySelectorAll("a").forEach((link) => {
        link.addEventListener("click", closeMenu);
      });

      const current = window.location.pathname;
      document.querySelectorAll(".top-link, .top-panel a").forEach((link) => {
        if (link.getAttribute("href") === current) {
          link.classList.add("is-active");
        }
      });
    })();
  </script>
</body>

</html>